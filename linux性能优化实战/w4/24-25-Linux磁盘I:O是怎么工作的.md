## 24-25 | 基础篇：Linux 磁盘I/O是怎么工作的

这篇文件主要介绍Linux磁盘I/O的工作原理

### 磁盘

磁盘的常见分类：机械磁盘和固态磁盘

+ 机械磁盘 缩写HDD，最小读写单位是扇区，一般为521字节
+ 固态磁盘 缩写SSD，最小读写单位是页，通常为4KB、8KB等

无论是哪种磁盘，随机的I/O都要比连续的I/O慢很多。

在Linux中，磁盘实际上是作为一个块设备来管理的，

### 通用块层

为了减少不同块设备的差异带来的影响，Linux通过一个统一的通用块层，来管理各种不同的块设备，他处在文件系统和磁盘驱动中间的一个块设备抽象层主要功能有两个：
+ 向上为文件系统和应用程序，几桶访问块设备的标准接口；向下，把各种异构的磁盘设备抽象为统一的块设备，并提供统一框架来管理这些设备的驱动程序
+ 还会给文件系统和应用程序发来的I/O请求排队，通过重新排序，请求合并等方式，提高磁盘读写效率

#### I/O请求排序调度算法

+ NONE：它完全不适用任何I/O调度器，对文件系统和应用程序的I/O起始不做任何处理，常用在虚拟机中
+ NOOP： 它是一个先入先出的队列，只做一些最基本的请求合并，常用语SSD
+ CFQ：常被称为完全公平调度器，现在很多发行版的默认I/O调度器，它为每个进程维护一个I/O调度队列，按照时间片来均匀分布每个进程I/O请求
+ DeadLine： 分别为读写请求创建不同的I/O度列，提高机械磁盘的吞吐量，并确保达到最终期限的请求被优先处理，多用在I/O压力比较重的场景

### I/O栈

Linux存储系统的I/O栈，由上到下分为三个层次，分别为文件系统层，通用块层和设备层

+ 文件系统层：包括虚拟文件系统和其他各种文件系统的具体实现，它为上层的应用程序，提供标准的文件访问接口；对下会通过通用块层，来存储和管理磁盘数据
+ 通用块层，包括块设备I/O队列和I/O调度器，它会对文件系统的I/O请求进行排队，再通过重新排序和请求合并，然后才要发送给下一级的块设备层
+ 设备层，包括存储设备和相应的驱动程序，负责最终物理设备的I/O操作

### 磁盘性能指标

衡量磁盘性能的标准通常为五个常见指标，使用率，饱和度，IOPS，吞吐量以及响应时间

+ 使用率：是指磁盘处理I/O的时间百分比，过高的使用率，通常意味着磁盘I/O存在性能瓶颈
+ 饱和度：是指磁盘处理I/O的繁忙程度，过高的饱和度，意味着磁盘存在严重的性能瓶颈，当为100%时，无法接受新的I/O请求
+ IOPS：每秒的I/O请求数
+ 吞吐量：每秒的I/O请求大小
+ 响应时间：I/O请求从发出到收到响应的间隔时间

在数据库、大量小文件等这些随机读写比较多的场景中，IOPS更能反映系统的整体性能；而在多媒体等顺序读写较多的场景中，吞吐量才更能反映整体性能

磁盘性能测试工具fio

### 磁盘I/O观测

iostat它是常用的磁盘I/O性能观测工具，提供了每个磁盘的使用率，IOPS，吞吐量等各种常见的性能指标，这些指标其实来自于/proc/diskstats

```sh
# -d -x表示显示所有磁盘I/O的指标
$ iostat -d -x 1
Device:         rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util
vda               0.00     0.36    0.03   11.83     0.45    60.79    10.33     0.06    5.20    1.20    5.21   3.80   4.51
dm-0              0.00     0.00    0.04    0.02     1.12     0.84    63.11     0.00    4.07    2.66    6.92   0.65   0.00
dm-1              0.00     0.00    0.00    0.00     0.00     0.00    34.50     0.00    0.98    0.70    2.28   0.52   0.00
dm-3              0.00     0.00    0.00    0.00     0.00     0.00    34.50     0.00    1.18    0.90    2.46   0.69   0.00
dm-2              0.00     0.00    0.00    0.00     0.00     0.00    34.50     0.00    1.34    0.15    6.85   0.74   0.00
dm-4              0.00     0.00    0.00    0.00     0.00     0.00    34.50     0.00    1.42    0.10    7.56   0.81   0.00
dm-5              0.00     0.00    0.00    0.00     0.02     0.00    68.79     0.00    3.62    3.62    3.56   0.20   0.00
dm-6              0.00     0.00    0.00    0.00     0.01     0.00    44.35     0.00  253.59  269.80    2.76   2.43   0.00
dm-9              0.00     0.00    0.00    0.00     0.00     0.00    34.81     0.00    0.84    0.04    4.92   0.64   0.00
dm-10             0.00     0.00    0.00    0.00     0.01     0.01    46.64     0.00    4.71    2.09    6.71   3.30   0.00
dm-7              0.00     0.00    0.00    0.00     0.01     0.00    84.32     0.00    1.94    0.87   21.31   0.18   0.00
dm-8              0.00     0.00    0.00    0.00     0.01     0.00    66.67     0.00    2.17    1.28   15.50   0.21   0.00
```

+ r/s:每秒发送给磁盘的读请求数    合并后的请求数
+ w/s：每秒发送给磁盘的写请求数，合并后的请求数
+ rkB/s：每秒从磁盘读取的数据量，单位为KB
+ wkB/s：每秒向磁盘写入的数据量，单位为KB
+ rrqm/s：每秒合并的读请求数，%rrqm表示合并读请求的百分比
+ wrqm/s：每秒合并的写请求数，%wrqm表示合并写请求的百分比
+ r_await：读请求处理完成等待时间，包括队列中的等待时间和设备实际处理的时间，单位为毫秒
+ w_await：写请求处理完成时间，包括队列中的等待时间和设备实际处理的时间，单位为毫秒
+ aqu-sz：平均请求队列长度，旧版中为avgqu-sz
+ rareq-se：平均读请求大小，单位为KB
+ wareq-sz：平均写请求大小，单位为KB
+ svctm：处理I/O请求所需的平均时间（不包括等待时间），单位为毫秒，这是推断数据，
+ %util：磁盘处理I/O的时间百分比，即使用率，由于可能存在并行I/O，100%并不一定代表磁盘I/O饱和

这些指标中的 
+ %util：就是前面提到的磁盘I/O使用率
+ r/s+ w/s：就是IOPS
+ rKB/s+wKB/s:吞吐量
+ r_await+w_await:就是响应时间

### 进程I/O观测

使用pidstat和iotop这两个工具

#### pidstat

```sh
root@devops-064167:/home/hero# pidstat -d 1
Linux 3.10.0-327.el7.x86_64 (devops-064167.tst.vm.tjcn2.bmsre.com) 	06/17/2020 	_x86_64_	(8 CPU)

11:48:38 AM   UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s  Command
11:48:39 AM     0    290120      0.00     31.37      0.00  etcd
```

主要包括如下内容

+ 用户ID（UID）和进程ID（PID）
+ 每秒读取的数据大小（KB_rd/s），单位是KB
+ 每秒发出的写请求数据大小（KB_wr/s）,单位是KB
+ 每秒取消的写请求数据大小(KB_ccwr/s)，单位是KB
+ 块I/O延迟（iodelay），包括等待同步块I/O和换入块I/O结束的时间，单位是时钟周期

#### iotop

```sh
$ iotop
Total DISK READ :	0.00 B/s | Total DISK WRITE :      37.71 K/s
Actual DISK READ:	0.00 B/s | Actual DISK WRITE:      36.77 K/s
   TID  PRIO  USER     DISK READ  DISK WRITE  SWAPIN     IO>    COMMAND
290576 be/4 root        0.00 B/s   18.86 K/s  0.00 %  2.45 % etcd --advertise-cli~etes/pki/etcd/ca.crt
290207 be/4 root        0.00 B/s   11.31 K/s  0.00 %  0.05 % etcd --advertise-cli~etes/pki/etcd/ca.crt
```
前两行表示进程的磁盘读写大小总数和磁盘真实的读写大小总数



