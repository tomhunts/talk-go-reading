## 22 | 内存性能篇答疑？

### 内存回收与OOM

一旦发现内存紧张，系统通过三种方式回收内存，分别为
+ 基于LRU算法，回收缓存
+ 基于Swap机制，回收不常访问的匿名页
+ 基于OOM机制，杀掉占用大量内存的进程

LRU算法维护着active和inactive两个双向链表，其中：active记录活跃的内存页，inactive记录非活跃的内存页，越接近链表尾部，表示内存页越不常访问，这样，在回收内存时，系统就可以根据活跃程度，优先回收不活跃的内存

活跃和非活跃的内存页，按照类型的不同，又分别分为文件页和匿名页，对应着缓存回收和Swap回收，可通过/proc/meminfo查看他们的大小

如果通过内存回收还是不够用就会通过OOM来杀死进程，执行如下命令查看OOM日志 

```sh
dmesg | grep -i "Out of memory"
```

### 如何统计所有进程的物理内存使用量

使用如下命令

```sh

# 使用grep查找Pss指标后，再用awk计算累加值
$ grep Pss /proc/[1-9]*/smaps | awk '{total+=$2}; END {printf "%d kB\n", total }'
391266 kB
```

### 内存泄漏案例的优化方法

不用动态内存分配方法，用数组来暂存计算结果，在大量内存的场景中，可以考虑用栈内存，内存池，HugePage等方法来优化内存的分配和管理


