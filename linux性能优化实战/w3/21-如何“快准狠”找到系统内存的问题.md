## 21 | 套路篇：如何“快准狠”找到系统内存的问题？

### 内存性能指标

#### 系统内存使用情况

+ 已用内存和剩余内存
+ 共享内存通过tmpfs实现
+ 可用内存时新进程可使用的最大内存，包括剩余内存和可回收缓存
+ 缓存包括磁盘读取文件的页缓存和Slab分配器中的可回收内存
+ 缓冲区是对原始磁盘块的临时存储，用来缓存将要写入磁盘的数据

#### 进程内存使用情况

+ 虚拟内存，包括了进程代码段，数据段，共享内存，已经申请的堆内存和已经换出的内存等
+ 常驻内存是进程实际使用的物理内存，不包括Swap和共享内存
+ 共享内存包括与其他进程共同使用的真实共享内存，还包括加载的动态链接库以及程序的代码段等
+ Swap内存是指通过Swap换出到磁盘的内存

#### 缺页异常
分为两种场景
+ 直接从物理内存中分配时，被称为次缺页异常
+ 需要磁盘I/O介入时，被称为主缺页异常

#### Swap的使用情况

+ 已用空间和剩余空间
+ 换入和换出速度


### 内存性能工具

常用的有free，top，ps，proc文件系统，cachetop，vmstat，memleak，sar等，主要通过分享的下面的工具图来分析

### 快速分析内存的性能瓶颈

+ 通过free和top查看整体的内存使用情况
+ 使用vmstat和pidstat查看一段时间的趋势，从而判断内存问题类型
+ 最后再详细分析问题，比如是内存分配问题，缓存以及缓冲区的分析，进程的内存分析等

结合分析内存使用流程图进行来分析


### 常见的优化思路

+ 禁止Swap，如果必须开启，降低swapiness的值，
+ 减少内存的动态分配，比如使用内存池和大页等
+ 尽量使用缓存和缓冲区来访问数据，比如使用堆栈明确生命内存空间，来存储需要缓存的数据，或者使用redis等
+ 使用cgroups等方式限制进程的内存使用情况
+ 通过/proc/pid/oom_adj，调整核心应用的oom_score，减小相应的程序在内存不足时被oom杀死的概率

