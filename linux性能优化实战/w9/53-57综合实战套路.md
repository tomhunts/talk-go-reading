## 53-57 综合实战套路

### 系统监控整体思路

USE法：将系统资源的性能指标，简化为三个类别，使用率，饱和度以及错误数
	使用率：表示资源用于服务的时间或容量百分比，
	饱和度：表示资源的繁忙程度，通常与等待队列的长度相关
	错误数：表示发生错误的事件个数

监控系统通常由：数据采集，数据存储，数据查询和处理，告警，以及可视化展示

### 应用监控的一般思路

核心指标：请求数，错误率，响应时间，应用进程的资源使用情况，应用程序间的调用情况，程序内部核心逻辑的运行情况
使用全链路跟踪程序，去定位问题的具体根源

进行日志监控：使用ELK技术栈。
Logstash：负责对各个日志源采集日志。然后进行预处理，最后再把初步处理过的日志发送 给elasticsearch进行索引
Elasticsearch：负责对日志进行索引，并提供一个完成的全文索索引擎，这样就可以方便你从日志中检索需要的数据
Kibana：负责日志进行可视化分析，包括日志搜索、处理以及仪表板展示

注意：ELK技术栈中的Logstash资源消耗比较大，在资源紧张的情况下多用Fluentd进行替换，当然也可以使用filebeat，

### 分析性能问题的一般步骤

主要通过四个方面：
CPU性能分析：使用top，vmstat，pidstat，strace以及perf等工具
内存性能分析：与CPU差不多，
磁盘和文件系统I/O性能分析：通过iostat查看性能瓶颈，之后通过pidstat和vmstat来判断来源，之后分析
网络性能分析：包括网络接口和内核资源，针对不同的协议层进行不同的分析。

### 性能优化的一般方法
CPU优化：在于排除所有不必要的工作，充分利用CPU缓存并减少进程调度对性能的影响
	+ 第一种：把进程绑定到一个或多个CPU上，充分利用CPU缓存的本地行，减少进程间的相互影响
	+ 第二种：为中断处理程序开启多CPU负载均衡，以便在发生大量中断时，可以充分利用多CPU的优势分摊负载
	+ 第三种：使用Cgroups等方法，为进程设置资源限制。为和兴应用程序设置更高的优先级
内存优化：
	+ 第一种：除非有必要，swap应该禁止掉，
	+ 第二种：使用Cgroups等方法，为进程是指内存限制，对于核心应用，海英减低OOM_score
	+ 第三种：使用大页，内存池等方法，减少内存的动态分配，从而减少缺页异常
磁盘和文件系统I/O优化：
	+ 第一种：替换硬件，通过SSD替代HDD，或者使用RAID等方法，提升I/O性能
	+ 第二种：针对磁盘和应用程序I/O模型的特征，选择最合适的I/O调度算法，比如SSD和虚拟机的磁盘使用noop调度算法，数据库应用更推荐使用deadline算法
	+ 第三种：优化文件系统和磁盘的缓存，缓冲区，比如优化脏页的刷新频率，脏页限额，以及内核回收目录项缓存和索引节点缓存的倾向等
	+ 使用不同磁盘隔离不同应用的数据，优化文件系统的配置选项，优化磁盘预读，增大磁盘队列长度等
网络优化：
	+ 在内核资源和网络协议角度来说：增大套接字缓冲区，连接跟踪表，最大半连接数，最大文件描述符数，本地端口范围等；较少TIMEOUT超时时间，SYN+ACK重传数，Keepalive探测时间等异常处理参数；开启端口复用，反向地址校验，调整MTU大小等
	+ 从网络接口的角度：将原本在CPU上执行的工作，卸载到网卡中执行，开启网卡的GRO，GSO，RSS，VXLAN等卸载功能；也可以开启网络接口的多队列功能；增大网络接口的缓冲区大小以及队列长度
	+ 最后：使用DPDK技术，跳过内核协议栈。直接由用户态进程用轮训的方式，来处理网络请求，同时，再结合大页，CPU绑定，内存对其，流水线并发等多种机制；使用内核自带的XDP技术，在网络包进如内核协议栈前对其进行处理
应用程序优化：
	+ 第一：从CPU使用角度，优化代码，优化算法，异步处理，以及编译器优化等
	+ 第二：从数据访问角度，使用缓存，写时复制，增加I/O尺寸等
	+ 第三：从内存管理角度，使用大页，内存池等
	+ 第四：从网络角度：使用I/O多路复用，长连接代替短连接，DNS缓存等方法，
	+ 第五：从进行工作模型，异步处理，多进程或多线程
	+ 第六：除此之外：使用消息度列，CDN，负载均衡等方法。
